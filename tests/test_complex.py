from typstdiff import __version__
import pytest
from typstdiff.file_converter import FileConverter
from typstdiff.iterating import Comparison
from typstdiff.main import get_file_path_without_extension
from tests.test_typstdiff import pytestmark
import json

# ------------------------------------------------------------
# duplicated setup and fixtures - to improve later

def perform_jsondiff_on_typst_files(old_version_file, new_version_file, diff_file):
    old_v_file = get_file_path_without_extension(old_version_file)
    new_v_file = get_file_path_without_extension(new_version_file)
    diff_file = get_file_path_without_extension(diff_file)

    file_converter = FileConverter()
    file_converter.convert_with_pandoc('typst', 'json', f'./tests/test_complex/{old_v_file}/{new_v_file}.typ', f'./tests/test_complex/{old_v_file}/{new_v_file}.json')
    file_converter.convert_with_pandoc('typst', 'json', f'./tests/test_complex/{old_v_file}/{old_v_file}.typ', f'./tests/test_complex/{old_v_file}/{old_v_file}.json')
    comparison = Comparison(f'./tests/test_complex/{old_v_file}/{new_v_file}.json', f'./tests/test_complex/{old_v_file}/{old_v_file}.json')
    comparison.parse()
    return comparison.parsed_changed_file

@pytest.fixture
def setup_files_update(request):
    filename = request.param
    old_version_file = f'test_complex/{filename}/{filename}.typ'
    new_version_file = f'test_complex/{filename}/{filename}_updated.typ'
    diff_file = f'test_complex/{filename}/{filename}_diff_updated.json'
    return old_version_file, new_version_file, diff_file

@pytest.fixture
def setup_files_delete(request):
    filename = request.param
    old_version_file = f'test_complex/{filename}/{filename}.typ'
    new_version_file = f'test_complex/{filename}/{filename}_deleted.typ'
    diff_file = f'test_complex/{filename}/{filename}_diff_deleted.json'
    return old_version_file, new_version_file, diff_file

@pytest.fixture
def setup_files_insert(request):
    filename = request.param
    old_version_file = f'test_complex/{filename}/{filename}.typ'
    new_version_file = f'test_complex/{filename}/{filename}_inserted.typ'
    diff_file = f'test_complex/{filename}/{filename}_diff_inserted.json'
    return old_version_file, new_version_file, diff_file


# ------------------------------------------------------------


@pytest.mark.parametrize('setup_files_update', ['para'], indirect=True)
@pytest.mark.update
def test_typstdiff_update_para(setup_files_update):
    old_version_file, new_version_file, diff_file = setup_files_update
    diff_json = perform_jsondiff_on_typst_files(old_version_file, new_version_file, diff_file)
    
    with open('tests/test_complex/para/para_updated_result.json', 'w') as json_file:
        json.dump(diff_json, json_file)
    
    expected_json = {"pandoc-api-version": [1, 23, 1], "meta": {}, "blocks": [{"t": "Para", "c": [{"t": "Str", "c": "In"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "report,"}, {"t": "Space"}, {"t": "Str", "c": "we"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "explore"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "SoftBreak"}, {"t": "Str", "c": "various"}, {"t": "Space"}, {"t": "Strikeout", "c": [{"t": "Str", "c": "factors"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "changed"}]}, {"t": "Space"}, {"t": "Strikeout", "c": [{"t": "Str", "c": "that"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "changed"}]}, {"t": "Space"}, {"t": "Str", "c": "influence"}, {"t": "Space"}, {"t": "Emph", "c": [{"t": "Str", "c": "fluid"}, {"t": "SoftBreak"}, {"t": "Str", "c": "dynamics"}]}, {"t": "Space"}, {"t": "Str", "c": "in"}, {"t": "Space"}, {"t": "Str", "c": "glaciers"}, {"t": "Space"}, {"t": "Str", "c": "ha"}, {"t": "Space"}, {"t": "Str", "c": "they"}, {"t": "SoftBreak"}, {"t": "Str", "c": "contribute"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Strikeout", "c": [{"t": "Str", "c": "the"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "changed"}]}, {"t": "Space"}, {"t": "Str", "c": "formation"}, {"t": "Space"}, {"t": "Str", "c": "and"}, {"t": "SoftBreak"}, {"t": "Str", "c": "behaviour"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "these"}, {"t": "Space"}, {"t": "Str", "c": "natural"}, {"t": "Space"}, {"t": "Str", "c": "structures."}]}, {"t": "Para", "c": [{"t": "Str", "c": "All"}, {"t": "Space"}, {"t": "Str", "c": "manuscripts"}, {"t": "Space"}, {"t": "Str", "c": "are"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "be"}, {"t": "Space"}, {"t": "Strikeout", "c": [{"t": "Str", "c": "submitted"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "changed"}]}, {"t": "Space"}, {"t": "Str", "c": "electronically"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "ScholarOne"}, {"t": "Space"}, {"t": "Str", "c": "Abstracts"}, {"t": "Space"}, {"t": "Str", "c": "site"}, {"t": "Space"}, {"t": "Str", "c": "created"}, {"t": "Space"}, {"t": "Str", "c": "for"}, {"t": "Space"}, {"t": "Str", "c": "each"}, {"t": "Space"}, {"t": "Str", "c": "conference."}, {"t": "Space"}, {"t": "Str", "c": "The"}, {"t": "Space"}, {"t": "Str", "c": "manuscript"}, {"t": "Space"}, {"t": "Str", "c": "upload"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "be"}, {"t": "Space"}, {"t": "Str", "c": "enabled"}, {"t": "Space"}, {"t": "Str", "c": "several"}, {"t": "Space"}, {"t": "Str", "c": "weeks"}, {"t": "Space"}, {"t": "Str", "c": "after"}, {"t": "Space"}, {"t": "Str", "c": "acceptance"}, {"t": "Space"}, {"t": "Str", "c": "notices"}, {"t": "Space"}, {"t": "Str", "c": "have"}, {"t": "Space"}, {"t": "Str", "c": "been"}, {"t": "Space"}, {"t": "Str", "c": "sent."}, {"t": "Space"}, {"t": "Str", "c": "Presenting"}, {"t": "Space"}, {"t": "Str", "c": "authors"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "accepted"}, {"t": "Space"}, {"t": "Str", "c": "papers"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "receive"}, {"t": "Space"}, {"t": "Str", "c": "an"}, {"t": "Space"}, {"t": "Str", "c": "email"}, {"t": "Space"}, {"t": "Str", "c": "with"}, {"t": "Space"}, {"t": "Str", "c": "instructions"}, {"t": "Space"}, {"t": "Str", "c": "when"}, {"t": "Space"}, {"t": "Str", "c": "manuscript"}, {"t": "Space"}, {"t": "Str", "c": "submission"}, {"t": "Space"}, {"t": "Str", "c": "opens."}, {"t": "Space"}, {"t": "Str", "c": "It"}, {"t": "Space"}, {"t": "Str", "c": "is"}, {"t": "Space"}, {"t": "Str", "c": "important"}, {"t": "Space"}, {"t": "Str", "c": "that"}, {"t": "Space"}, {"t": "Str", "c": "presenting"}, {"t": "Space"}, {"t": "Str", "c": "authors"}, {"t": "Space"}, {"t": "Str", "c": "keep"}, {"t": "Space"}, {"t": "Str", "c": "their"}, {"t": "Space"}, {"t": "Str", "c": "email"}, {"t": "Space"}, {"t": "Str", "c": "addresses"}, {"t": "Space"}, {"t": "Str", "c": "up-to-date"}, {"t": "Space"}, {"t": "Str", "c": "so"}, {"t": "Space"}, {"t": "Str", "c": "they"}, {"t": "Space"}, {"t": "Str", "c": "do"}, {"t": "Space"}, {"t": "Str", "c": "not"}, {"t": "Space"}, {"t": "Str", "c": "miss"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "notice."}]}, {"t": "Para", "c": [{"t": "Str", "c": "It"}, {"t": "Space"}, {"t": "Str", "c": "is"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "responsibility"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "author"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "obtain"}, {"t": "Space"}, {"t": "Str", "c": "any"}, {"t": "Space"}, {"t": "Str", "c": "required"}, {"t": "Space"}, {"t": "Str", "c": "government"}, {"t": "Space"}, {"t": "Str", "c": "or"}, {"t": "Space"}, {"t": "Str", "c": "company"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "for"}, {"t": "Space"}, {"t": "Str", "c": "their"}, {"t": "Space"}, {"t": "Strikeout", "c": [{"t": "Str", "c": "papers"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "changed"}]}, {"t": "Space"}, {"t": "Str", "c": "in"}, {"t": "Space"}, {"t": "Str", "c": "advance"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "publication."}, {"t": "Space"}, {"t": "Str", "c": "Start"}, {"t": "Space"}, {"t": "Str", "c": "early"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "determine"}, {"t": "Space"}, {"t": "Str", "c": "if"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "are"}, {"t": "Space"}, {"t": "Str", "c": "required;"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "process"}, {"t": "Space"}, {"t": "Str", "c": "can"}, {"t": "Space"}, {"t": "Str", "c": "take"}, {"t": "Space"}, {"t": "Str", "c": "several"}, {"t": "Space"}, {"t": "Str", "c": "weeks."}]}]}
    

    assert diff_json == expected_json


@pytest.mark.parametrize('setup_files_delete', ['para'], indirect=True)
@pytest.mark.delete
def test_typstdiff_delete_para(setup_files_delete):

    old_version_file, new_version_file, diff_file = setup_files_delete
    diff_json = perform_jsondiff_on_typst_files(old_version_file, new_version_file, diff_file)

    with open('tests/test_complex/para/para_deleted_result.json', 'w') as json_file:
        json.dump(diff_json, json_file)

    expected_json = {"pandoc-api-version": [1, 23, 1], "meta": {}, "blocks": [{"t": "Para", "c": [{"t": "Str", "c": "In"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "report,"}, {"t": "Space"}, {"t": "Str", "c": "we"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "explore"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "SoftBreak"}, {"t": "Str", "c": "various"}, {"t": "Space"}, {"t": "Str", "c": "factors"}, {"t": "Space"}, {"t": "Str", "c": "that"}, {"t": "Space"}, {"t": "Str", "c": "influence"}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Emph", "c": [{"t": "Str", "c": "fluid"}, {"t": "SoftBreak"}, {"t": "Str", "c": "dynamics"}]}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "in"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "glaciers"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "ha"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "they"}]}, {"t": "Strikeout", "c": [{"t": "SoftBreak"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "contribute"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "to"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "the"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "formation"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "and"}]}, {"t": "Strikeout", "c": [{"t": "SoftBreak"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "behaviour"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "of"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "these"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "natural"}]}, {"t": "Space"}, {"t": "Str", "c": "structures."}]}, {"t": "Para", "c": [{"t": "Strikeout", "c": [{"t": "Str", "c": "All"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "manuscripts"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "are"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "to"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "be"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "submitted"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "electronically"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "to"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "the"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "ScholarOne"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "Abstracts"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "site"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "created"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "for"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "each"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "conference."}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "The"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "manuscript"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "upload"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "will"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "be"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "enabled"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "several"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "weeks"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "after"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "acceptance"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "notices"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "have"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "been"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "sent."}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "Presenting"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "authors"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "of"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "accepted"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "papers"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "will"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "receive"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "an"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "email"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "with"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "instructions"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "when"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "manuscript"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "submission"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "opens."}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "It"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "is"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "important"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "that"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "presenting"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "authors"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "keep"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "their"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "email"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "addresses"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "up-to-date"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "so"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "they"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "do"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "not"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "miss"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "this"}]}, {"t": "Strikeout", "c": [{"t": "Space"}]}, {"t": "Strikeout", "c": [{"t": "Str", "c": "notice."}]}]}, {"t": "Para", "c": [{"t": "Str", "c": "It"}, {"t": "Space"}, {"t": "Str", "c": "is"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "responsibility"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "author"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "obtain"}, {"t": "Space"}, {"t": "Str", "c": "any"}, {"t": "Space"}, {"t": "Str", "c": "required"}, {"t": "Space"}, {"t": "Str", "c": "government"}, {"t": "Space"}, {"t": "Str", "c": "or"}, {"t": "Space"}, {"t": "Str", "c": "company"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "for"}, {"t": "Space"}, {"t": "Str", "c": "their"}, {"t": "Space"}, {"t": "Str", "c": "papers"}, {"t": "Space"}, {"t": "Str", "c": "in"}, {"t": "Space"}, {"t": "Str", "c": "advance"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "publication."}, {"t": "Space"}, {"t": "Str", "c": "Start"}, {"t": "Space"}, {"t": "Str", "c": "early"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "determine"}, {"t": "Space"}, {"t": "Str", "c": "if"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "are"}, {"t": "Space"}, {"t": "Str", "c": "required;"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "process"}, {"t": "Space"}, {"t": "Str", "c": "can"}, {"t": "Space"}, {"t": "Str", "c": "take"}, {"t": "Space"}, {"t": "Str", "c": "several"}, {"t": "Space"}, {"t": "Str", "c": "weeks."}]}]}
    assert diff_json == expected_json


@pytest.mark.parametrize('setup_files_insert', ['para'], indirect=True)
@pytest.mark.insert
def test_typstdiff_insert_para(setup_files_insert):
    old_version_file, new_version_file, diff_file = setup_files_insert
    diff_json = perform_jsondiff_on_typst_files(old_version_file, new_version_file, diff_file)

    with open('tests/test_complex/para/para_inserted_result.json', 'w') as json_file:
        json.dump(diff_json, json_file)

    expected_json = {"pandoc-api-version": [1, 23, 1], "meta": {}, "blocks": [{"t": "Para", "c": [{"t": "Str", "c": "In"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "report,"}, {"t": "Space"}, {"t": "Str", "c": "we"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "explore"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "SoftBreak"}, {"t": "Str", "c": "various"}, {"t": "Space"}, {"t": "Str", "c": "factors"}, {"t": "Space"}, {"t": "Str", "c": "that"}, {"t": "Space"}, {"t": "Str", "c": "influence"}, {"t": "Space"}, {"t": "Emph", "c": [{"t": "Str", "c": "fluid"}, {"t": "SoftBreak"}, {"t": "Str", "c": "dynamics"}]}, {"t": "Space"}, {"t": "Str", "c": "in"}, {"t": "Space"}, {"t": "Str", "c": "glaciers"}, {"t": "Space"}, {"t": "Str", "c": "ha"}, {"t": "Space"}, {"t": "Str", "c": "they"}, {"t": "SoftBreak"}, {"t": "Str", "c": "contribute"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "formation"}, {"t": "Space"}, {"t": "Str", "c": "and"}, {"t": "SoftBreak"}, {"t": "Str", "c": "behaviour"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "these"}, {"t": "Space"}, {"t": "Str", "c": "natural"}, {"t": "Space"}, {"t": "Str", "c": "structures."}]}, {"t": "Para", "c": [{"t": "Underline", "c": [{"t": "Str", "c": "Something"}]}, {"t": "Underline", "c": [{"t": "Space"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "new."}]}]}, {"t": "Para", "c": [{"t": "Str", "c": "All"}, {"t": "Space"}, {"t": "Str", "c": "manuscripts"}, {"t": "Space"}, {"t": "Str", "c": "are"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "be"}, {"t": "Space"}, {"t": "Str", "c": "submitted"}, {"t": "Space"}, {"t": "Str", "c": "electronically"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "ScholarOne"}, {"t": "Space"}, {"t": "Str", "c": "Abstracts"}, {"t": "Space"}, {"t": "Str", "c": "site"}, {"t": "Space"}, {"t": "Str", "c": "created"}, {"t": "Space"}, {"t": "Str", "c": "for"}, {"t": "Space"}, {"t": "Str", "c": "each"}, {"t": "Space"}, {"t": "Str", "c": "conference."}, {"t": "Space"}, {"t": "Str", "c": "The"}, {"t": "Space"}, {"t": "Str", "c": "manuscript"}, {"t": "Space"}, {"t": "Str", "c": "upload"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "be"}, {"t": "Space"}, {"t": "Str", "c": "enabled"}, {"t": "Space"}, {"t": "Str", "c": "several"}, {"t": "Space"}, {"t": "Str", "c": "weeks"}, {"t": "Space"}, {"t": "Str", "c": "after"}, {"t": "Space"}, {"t": "Str", "c": "acceptance"}, {"t": "Space"}, {"t": "Str", "c": "notices"}, {"t": "Space"}, {"t": "Str", "c": "have"}, {"t": "Space"}, {"t": "Str", "c": "been"}, {"t": "Space"}, {"t": "Str", "c": "sent."}, {"t": "Space"}, {"t": "Str", "c": "Presenting"}, {"t": "Space"}, {"t": "Str", "c": "authors"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "accepted"}, {"t": "Space"}, {"t": "Str", "c": "papers"}, {"t": "Space"}, {"t": "Str", "c": "will"}, {"t": "Space"}, {"t": "Str", "c": "receive"}, {"t": "Space"}, {"t": "Str", "c": "an"}, {"t": "Space"}, {"t": "Str", "c": "email"}, {"t": "Space"}, {"t": "Str", "c": "with"}, {"t": "Space"}, {"t": "Str", "c": "instructions"}, {"t": "Space"}, {"t": "Str", "c": "when"}, {"t": "Space"}, {"t": "Str", "c": "manuscript"}, {"t": "Space"}, {"t": "Str", "c": "submission"}, {"t": "Space"}, {"t": "Str", "c": "opens."}, {"t": "Space"}, {"t": "Str", "c": "It"}, {"t": "Space"}, {"t": "Str", "c": "is"}, {"t": "Space"}, {"t": "Str", "c": "important"}, {"t": "Space"}, {"t": "Str", "c": "that"}, {"t": "Space"}, {"t": "Str", "c": "presenting"}, {"t": "Space"}, {"t": "Str", "c": "authors"}, {"t": "Space"}, {"t": "Str", "c": "keep"}, {"t": "Space"}, {"t": "Str", "c": "their"}, {"t": "Space"}, {"t": "Str", "c": "email"}, {"t": "Space"}, {"t": "Str", "c": "addresses"}, {"t": "Space"}, {"t": "Str", "c": "up-to-date"}, {"t": "Space"}, {"t": "Str", "c": "so"}, {"t": "Space"}, {"t": "Str", "c": "they"}, {"t": "Space"}, {"t": "Str", "c": "do"}, {"t": "Space"}, {"t": "Str", "c": "not"}, {"t": "Space"}, {"t": "Str", "c": "miss"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "notice."}]}, {"t": "Para", "c": [{"t": "Str", "c": "It"}, {"t": "Space"}, {"t": "Str", "c": "is"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "responsibility"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "author"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "obtain"}, {"t": "Space"}, {"t": "Str", "c": "any"}, {"t": "Space"}, {"t": "Str", "c": "required"}, {"t": "Space"}, {"t": "Str", "c": "government"}, {"t": "Space"}, {"t": "Str", "c": "or"}, {"t": "Space"}, {"t": "Str", "c": "company"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "for"}, {"t": "Space"}, {"t": "Str", "c": "their"}, {"t": "Space"}, {"t": "Str", "c": "papers"}, {"t": "Space"}, {"t": "Str", "c": "in"}, {"t": "Space"}, {"t": "Str", "c": "advance"}, {"t": "Space"}, {"t": "Str", "c": "of"}, {"t": "Space"}, {"t": "Str", "c": "publication."}, {"t": "Space"}, {"t": "Str", "c": "Start"}, {"t": "Space"}, {"t": "Str", "c": "early"}, {"t": "Space"}, {"t": "Str", "c": "to"}, {"t": "Space"}, {"t": "Str", "c": "determine"}, {"t": "Space"}, {"t": "Str", "c": "if"}, {"t": "Space"}, {"t": "Str", "c": "the"}, {"t": "Space"}, {"t": "Str", "c": "reviews"}, {"t": "Space"}, {"t": "Str", "c": "are"}, {"t": "Space"}, {"t": "Str", "c": "required;"}, {"t": "Space"}, {"t": "Str", "c": "this"}, {"t": "Space"}, {"t": "Str", "c": "process"}, {"t": "Space"}, {"t": "Str", "c": "can"}, {"t": "Space"}, {"t": "Str", "c": "take"}, {"t": "Space"}, {"t": "Str", "c": "several"}, {"t": "Space"}, {"t": "Str", "c": "weeks."}]}, {"t": "Para", "c": [{"t": "Underline", "c": [{"t": "Str", "c": "New"}]}, {"t": "Underline", "c": [{"t": "Space"}]}, {"t": "Underline", "c": [{"t": "Str", "c": "paragraph."}]}]}]}

    assert diff_json == expected_json